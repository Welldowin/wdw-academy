<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô & ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ - Well-Do-Win Academy</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Kanit', sans-serif;
      background-color: #fffdf5;
      color: #333;
    }

    header {
      background-color: #1E3D8F;
      color: white;
      padding: 0 1rem 1.5rem;
      position: relative;
    }

    .top-nav {
      display: flex;
      justify-content: center;
      gap: 2rem;
      padding: 0.8rem 0;
      background-color: #162e6d;
    }

    .top-nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .logo-row {
      max-width: 1080px;
      margin: 1rem auto 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-block {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .logo-img {
      height: 60px;
      width: auto;
    }

    .school-name {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.9rem;
    }

    .user-name {
      background-color: rgba(0,0,0,0.2);
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
    }

    .logout-btn {
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: 1px solid white;
      background-color: transparent;
      color: white;
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: none;
    }

    .logout-btn:hover {
      background-color: rgba(255,255,255,0.2);
    }

    .main {
      max-width: 1080px;
      margin: 1.8rem auto 3rem;
      padding: 0 1rem;
      box-sizing: border-box;
    }

    .section-title {
      font-size: 1.5rem;
      color: #1E3D8F;
      margin: 0 0 0.6rem;
    }

    .card {
      background-color: #fdf7e8;
      border-radius: 16px;
      padding: 1.2rem 1.2rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      box-sizing: border-box;
      margin-bottom: 1.3rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1.6fr 1.4fr;
      gap: 1.2rem;
      margin-bottom: 1.5rem;
    }

    .summary-item {
      font-size: 0.95rem;
      margin: 0.3rem 0;
      cursor: pointer;
    }

    .summary-item strong {
      font-size: 1.1rem;
    }

    .summary-item:hover {
      text-decoration: underline;
    }

    .primary-btn {
      padding: 0.55rem 1.4rem;
      border-radius: 999px;
      border: none;
      background-color: #D94C4C;
      color: white;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .primary-btn:hover {
      opacity: 0.96;
    }

    .tag {
      display: inline-block;
      font-size: 0.8rem;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      background-color: #ffe59e;
      margin-top: 0.3rem;
    }

    .pill {
      display: inline-block;
      padding: 0.18rem 0.65rem;
      border-radius: 999px;
      font-size: 0.78rem;
    }

    .pill-done {
      background-color: #c4f3c2;
      color: #255b26;
    }

    .pill-pending {
      background-color: #ffe59e;
      color: #664d00;
    }

    .courses-line {
      font-size: 0.9rem;
      color: #555;
      margin-top: 0.4rem;
    }

    .courses-line span {
      font-weight: 600;
      color: #1E3D8F;
    }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô */
    .hw-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .hw-table th,
    .hw-table td {
      border-bottom: 1px solid #eadfca;
      padding: 0.45rem 0.4rem;
      text-align: left;
    }

    .hw-table th {
      font-size: 0.8rem;
      color: #555;
    }

    .filter-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
      margin-bottom: 0.8rem;
      flex-wrap: wrap;
    }

    .filter-row select {
      padding: 0.4rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #d2c5aa;
      font-size: 0.85rem;
      background-color: #fff9ec;
    }

    /* ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ */
    .video-list {
      margin-top: 0.3rem;
    }

    .video-item {
      padding: 0.5rem 0.4rem;
      border-bottom: 1px dashed #e0cfac;
      font-size: 0.9rem;
    }

    .video-item:last-child {
      border-bottom: none;
    }

    .video-title {
      font-weight: 600;
    }

    .video-meta {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.15rem;
    }

    .video-actions {
      margin-top: 0.35rem;
    }

    .link-btn {
      padding: 0.25rem 0.8rem;
      border-radius: 999px;
      border: 1px solid #D94C4C;
      background-color: transparent;
      color: #D94C4C;
      font-size: 0.8rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .link-btn:hover {
      background-color: #D94C4C;
      color: white;
    }

    footer {
      background-color: #1E3D8F;
      color: white;
      text-align: center;
      padding: 1rem;
      font-size: 0.9rem;
    }
        .new-badge {
      display: inline-block;
      margin-left: 0.35rem;
      padding: 0.05rem 0.45rem;
      border-radius: 999px;
      background-color: #ff4d4d;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
      animation: blinkNew 1s infinite;
    }

    @keyframes blinkNew {
      0%, 50% {
        opacity: 1;
      }
      50.01%, 100% {
        opacity: 0;
      }
    }

    @media (max-width: 880px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
      .logo-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.8rem;
      }
    }
  </style>
</head>
<body>

  <header>
    <nav class="top-nav">
      <a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="courses.html">‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
      <a href="member.html">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
    </nav>

    <div class="logo-row">
      <div class="logo-block">
        <img src="logo.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ WDW" class="logo-img">
        <div>
          <div class="school-name">Well-Do-Win Academy</div>
          <div style="font-size:0.9rem;opacity:0.9;">Dashboard ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô & ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div>
        </div>
      </div>
      <div class="user-menu">
        <div class="user-name">
          üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="userNameDisplay">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
        </div>
<div class="token-badge">
    üíé ‡πÄ‡∏û‡∏ä‡∏£‡∏™‡∏∞‡∏™‡∏°: <span id="tokenCount">0</span>
  </div>
        <a href="#" class="logout-btn" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
      </div>
    </div>
  </header>

  <main class="main">
    <!-- ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° + ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö -->
    <div class="grid-2">
      <section class="card">
        <h2 class="section-title">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ üéì</h2>
        <p style="margin:0.3rem 0;">
          <strong id="studentNameLabel">‡∏ô‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</strong>
          | <span id="levelLabel">‡∏°.5 ‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡πå ‚Äì ‡∏Ñ‡∏ì‡∏¥‡∏ï</span>
        </p>
        <p style="margin:0.2rem 0 0.6rem;font-size:0.9rem;color:#555;">
          ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏π‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ
        </p>

        <p class="summary-item" id="sumHomeworkLine">
          üìù ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á:
          <strong><span id="pendingHomeworkCount">0</span> ‡∏ä‡∏¥‡πâ‡∏ô</strong>
        </p>
        <p class="summary-item" id="sumVideoLine">
          üé• ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏π / ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô:
          <strong><span id="videoCount">0</span> ‡∏Ñ‡∏•‡∏¥‡∏õ</strong>
        </p>

        <p class="courses-line">
          ‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:
          <span id="coursesLine">-</span>
        </p>

        <p class="tag">
          * ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏à‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠‡πÇ‡∏î‡∏¢‡∏Ñ‡∏£‡∏π/‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡πÄ‡∏ä‡πà‡∏ô DONE / ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß / CHECKED)
        </p>
      </section>

      <section class="card">
        <h3 style="margin-top:0;">‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏±‡∏î</h3>
        <p style="font-size:0.9rem;margin:0.4rem 0;">
          ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
          ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
        </p>
        <a href="member.html" class="primary-btn" style="margin-top:0.6rem;">
          ‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Member
        </a>
        <p style="font-size:0.8rem;color:#555;margin-top:0.8rem;">
          ‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠/‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô ‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏£‡∏π‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô Line: @welldowin
        </p>
      </section>
    </div>

    <!-- ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô -->
    <section class="card" id="homeworkSection">
      <div class="filter-row">
        <h2 class="section-title" style="margin:0;">‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
        <select id="homeworkCourseFilter">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>

      <div id="homeworkEmpty" style="font-size:0.9rem;color:#777;display:none;">
        ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      </div>

      <table class="hw-table" id="homeworkTable">
        <thead>
          <tr>
            <th style="width:18%;">‡∏Ñ‡∏≠‡∏£‡πå‡∏™</th>
            <th style="width:30%;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
            <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
            <th style="width:16%;">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
            <th style="width:12%;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          </tr>
        </thead>
        <tbody id="homeworkTbody">
          <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </tbody>
      </table>
    </section>

    <!-- ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ -->
    <section class="card" id="videoSection">
      <div class="filter-row">
        <h2 class="section-title" style="margin:0;">‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
        <select id="videoCourseFilter">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
      </div>

      <div id="videoEmpty" style="font-size:0.9rem;color:#777;display:none;">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      </div>

      <div class="video-list" id="videoList">
        <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
      </div>
<p style="font-size:0.8rem;color:#555;margin-top:0.6rem;">
  * ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™  
  ‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ñ‡∏ô‡∏•‡∏∞‡∏≠‡∏±‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏π/‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏≤‡∏á Line: @welldowin
</p>

    </section>
  </main>

  <footer>
    ¬© 2025 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏ß‡∏•‡∏î‡∏π‡∏ß‡∏¥‡∏ô - ‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏ß‡∏î‡∏ß‡∏¥‡∏ä‡∏≤
  </footer>

  <script>
  // ---------- 0) URL Apps Script ‡∏Ç‡∏≠‡∏á Dashboard ----------
  const DASHBOARD_API_URL =
    'https://script.google.com/macros/s/AKfycbyWopA9fBZHi7sJL-6qeaI2S_aGuVxP-_sJUC6Yie-qajiYDmeOorsznY6-1Z5NzKRT4Q/exec';

  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // ---------- 1) ‡πÄ‡∏ä‡πá‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ----------
  const userId    = localStorage.getItem('userId');
  const userEmail = localStorage.getItem('userEmail') || '';

  if (!userId) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Dashboard');
    window.location.href = 'login.html';
  }

  const urlParams     = new URLSearchParams(window.location.search);
  let focusCourseId   = urlParams.get('course') || '';

  const userNameDisplay       = document.getElementById('userNameDisplay');
  const studentNameLabel      = document.getElementById('studentNameLabel');
  const levelLabel            = document.getElementById('levelLabel');
  const coursesLineEl         = document.getElementById('coursesLine');

  const pendingHomeworkCountEl = document.getElementById('pendingHomeworkCount');
  const videoCountEl           = document.getElementById('videoCount');
  const tokenCountEl           = document.getElementById('tokenCount');

  const homeworkCourseFilter = document.getElementById('homeworkCourseFilter');
  const videoCourseFilter    = document.getElementById('videoCourseFilter');

  const hwTbody      = document.getElementById('homeworkTbody');
  const hwEmpty      = document.getElementById('homeworkEmpty');
  const hwTable      = document.getElementById('homeworkTable');
  const videoListEl  = document.getElementById('videoList');
  const videoEmptyEl = document.getElementById('videoEmpty');

  if (userEmail && userNameDisplay) {
    userNameDisplay.textContent = userEmail;
  }

  // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn.addEventListener('click', (e) => {
    e.preventDefault();
    localStorage.removeItem('userId');
    localStorage.removeItem('userEmail');
    window.location.href = 'index.html';
  });

  let GLOBAL_COURSES  = [];
  let GLOBAL_HOMEWORK = [];
  let GLOBAL_VIDEOS   = [];
   // ---------- ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡πÑ‡∏´‡∏ô/‡∏Ñ‡∏•‡∏¥‡∏õ‡πÑ‡∏´‡∏ô "‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ----------
  function markLatestByDate(arr, dateKey) {
    if (!Array.isArray(arr) || arr.length === 0) return;

    let maxTime   = -Infinity;
    let anyValid  = false;

    // ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤ "‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î"
    arr.forEach(item => {
      const raw = item[dateKey];
      if (!raw) return;

      const t = Date.parse(raw);
      if (isNaN(t)) return;

      anyValid = true;
      if (t > maxTime) {
        maxTime = t;
      }
    });

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ò‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
    arr.forEach(it => { delete it._isLatest; });

    // ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏™‡∏±‡∏Å‡∏≠‡∏±‡∏ô ‚Üí ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤)
    if (!anyValid) {
      arr[arr.length - 1]._isLatest = true;
      return;
    }

    // ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏¥‡∏î‡∏ò‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà = maxTime
    arr.forEach(item => {
      const raw = item[dateKey];
      if (!raw) return;

      const t = Date.parse(raw);
      if (isNaN(t)) return;

      if (t === maxTime) {
        item._isLatest = true;
      }
    });
  }


  // ---------- 3) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Apps Script (getDashboard) ----------
  async function loadDashboard() {
    const params = new URLSearchParams({
      action: 'getDashboard',
      userId: userId,
      email: userEmail,
      course: focusCourseId || ''
    });

    try {
      const res  = await fetch(`${DASHBOARD_API_URL}?${params.toString()}`);
      const json = await res.json();
      console.log('dashboard data:', json);

      if (json.status !== 'ok') {
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ: ' + (json.message || json.status));
        return;
      }

      const p        = json.profile   || {};
      const courses  = json.courses   || [];
      const homework = json.homework  || [];
      const videos   = json.videos    || [];
      const tokens   = json.tokens    || 0;
     
            // ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      markLatestByDate(homework, 'dueDate'); // ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      markLatestByDate(videos, 'date');      // ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î


      GLOBAL_COURSES  = courses;
      GLOBAL_HOMEWORK = homework;
      GLOBAL_VIDEOS   = videos;

      // ‡∏ñ‡πâ‡∏≤ script ‡∏ù‡∏±‡πà‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å focusCourseId ‡∏°‡∏≤‡πÉ‡∏´‡πâ ‡πÅ‡∏•‡πâ‡∏ß url ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ ‡πÉ‡∏´‡πâ sync ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
      if (json.focusCourseId && !focusCourseId) {
        focusCourseId = json.focusCourseId;
      }

      // ‡∏ñ‡πâ‡∏≤ status ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà PAID ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ member
      const statusUpper = String(p.status || '').toUpperCase();
      if (statusUpper !== 'PAID' && statusUpper !== '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß') {
        alert('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π Dashboard (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô PAID)');
        window.location.href = 'member.html';
        return;
      }

      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏∞‡∏î‡∏±‡∏ö
      const fullName = ((p.firstName || '') + (p.lastName ? ' ' + p.lastName : '')).trim();
      if (studentNameLabel && fullName) studentNameLabel.textContent = fullName;
      if (levelLabel)                   levelLabel.textContent       = p.level || '-';
      if (userNameDisplay && fullName)  userNameDisplay.textContent  = fullName;

      if (tokenCountEl) tokenCountEl.textContent = String(tokens);

      // ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      if (coursesLineEl) {
        if (courses.length === 0) {
          coursesLineEl.textContent = '-';
        } else {
          const names = courses.map(c => c.courseName || c.courseId).filter(Boolean);
          coursesLineEl.textContent = names.join(' | ');
        }
      }

      // ‡∏ó‡∏≥ map courseId -> ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏£‡πå‡∏™ ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      const courseNameMap = {};
      courses.forEach(c => {
        courseNameMap[c.courseId] = c.courseName || c.courseId;
      });

      renderHomeworkTable(homework, courseNameMap);
      renderVideoList(videos, courseNameMap);
      updateSummaryCounts(homework, videos);
      initFilters(courseNameMap);

    } catch (err) {
      console.error('loadDashboard error:', err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dashboard');
    }
  }

  // ---------- 4) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô ----------
  function renderHomeworkTable(homework, courseNameMap) {
    if (!hwTbody) return;
    hwTbody.innerHTML = '';

    if (!Array.isArray(homework) || homework.length === 0) {
      if (hwEmpty) hwEmpty.style.display = 'block';
      if (hwTable) hwTable.style.display = 'none';
      return;
    }

    if (hwEmpty) hwEmpty.style.display = 'none';
    if (hwTable) hwTable.style.display = 'table';

    homework.forEach(item => {
      const tr = document.createElement('tr');

      const cid      = item.courseId || '';
      const courseNm = courseNameMap[cid] || cid || '-';
      const title    = item.title   || '';
      const detail   = item.detail  || '';
      const dueDate  = item.dueDate || '';
      const status   = item.status  || '';

      const statusUpper = String(status).toUpperCase();
      const done =
        statusUpper === 'DONE' ||
        statusUpper === 'CHECKED' ||
        statusUpper === 'FINISHED' ||
        status === '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß';

      const pillClass = done ? 'pill pill-done' : 'pill pill-pending';
      const pillText  = done ? (status || 'DONE') : (status || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á');

        tr.innerHTML = `
        <td>${escapeHtml(courseNm)}</td>
        <td>
          ${escapeHtml(title)}
          ${item._isLatest ? '<span class="new-badge">New!!</span>' : ''}
        </td>
        <td>${escapeHtml(detail)}</td>
        <td>${escapeHtml(String(dueDate))}</td>
        <td><span class="${pillClass}">${escapeHtml(pillText)}</span></td>
      `;

      tr.dataset.courseId = cid;

      hwTbody.appendChild(tr);
    });
  }

  // ---------- 5) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ----------
  function renderVideoList(videos, courseNameMap) {
    if (!videoListEl) return;
    videoListEl.innerHTML = '';

    if (!Array.isArray(videos) || videos.length === 0) {
      if (videoEmptyEl) videoEmptyEl.style.display = 'block';
      return;
    }
    if (videoEmptyEl) videoEmptyEl.style.display = 'none';

    videos.forEach(v => {
      const cid      = v.courseId || '';
      const courseNm = courseNameMap[cid] || cid || '-';
      const title    = v.title || '';
      const url      = v.url   || '';
      const date     = v.date  || '';
      const duration = v.duration || '';

      const div = document.createElement('div');
      div.className = 'video-item';
      div.dataset.courseId = cid;
            div.innerHTML = `
        <div class="video-title">
          ${escapeHtml(title)}
          ${v._isLatest ? '<span class="new-badge">New!!</span>' : ''}
        </div>
        <div class="video-meta">
          ‡∏Ñ‡∏≠‡∏£‡πå‡∏™: ${escapeHtml(courseNm)}
          ${date ? ' | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î: ' + escapeHtml(String(date)) : ''}
          ${duration ? ' | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß: ' + escapeHtml(duration) : ''}
        </div>
        <div class="video-actions">
          ${url ? `<a href="${escapeHtml(url)}" target="_blank" class="link-btn">‡πÄ‡∏õ‡∏¥‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</a>` : ''}
        </div>
      `;

      videoListEl.appendChild(div);
    });
  }

  // ---------- 6) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ----------
  function updateSummaryCounts(homework, videos) {
    let pendingCount = 0;
    if (Array.isArray(homework)) {
      homework.forEach(item => {
        const status = String(item.status || '').toUpperCase();
        const done =
          status === 'DONE' ||
          status === 'CHECKED' ||
          status === 'FINISHED' ||
          item.status === '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß';
        if (!done) pendingCount += 1;
      });
    }

    const videoCount = Array.isArray(videos) ? videos.length : 0;

    if (pendingHomeworkCountEl) pendingHomeworkCountEl.textContent = String(pendingCount);
    if (videoCountEl)           videoCountEl.textContent           = String(videoCount);
  }

  // ---------- 7) Filter ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏™ ----------
  function initFilters(courseNameMap) {
    const courseIds = Object.keys(courseNameMap);
    const optionsHtml = ['<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>'].concat(
      courseIds.map(cid => {
        const name = courseNameMap[cid] || cid;
        return `<option value="${cid}">${escapeHtml(name)}</option>`;
      })
    ).join('');

    if (homeworkCourseFilter) {
      homeworkCourseFilter.innerHTML = optionsHtml;
      homeworkCourseFilter.addEventListener('change', () => {
        filterHomeworkByCourse(homeworkCourseFilter.value);
      });
    }

    if (videoCourseFilter) {
      videoCourseFilter.innerHTML = optionsHtml;
      videoCourseFilter.addEventListener('change', () => {
        filterVideosByCourse(videoCourseFilter.value);
      });
    }

    const sumHwLine  = document.getElementById('sumHomeworkLine');
    const sumVidLine = document.getElementById('sumVideoLine');

    if (sumHwLine) {
      sumHwLine.addEventListener('click', () => {
        document.getElementById('homeworkSection')
          .scrollIntoView({behavior:'smooth', block:'start'});
      });
    }
    if (sumVidLine) {
      sumVidLine.addEventListener('click', () => {
        document.getElementById('videoSection')
          .scrollIntoView({behavior:'smooth', block:'start'});
      });
    }
  }

  function filterHomeworkByCourse(cid) {
    if (!hwTbody) return;
    const rows = hwTbody.querySelectorAll('tr');
    rows.forEach(tr => {
      const rowCid = tr.dataset.courseId || '';
      tr.style.display = (!cid || cid === rowCid) ? '' : 'none';
    });
  }

  function filterVideosByCourse(cid) {
    if (!videoListEl) return;
    const items = videoListEl.querySelectorAll('.video-item');
    items.forEach(div => {
      const rowCid = div.dataset.courseId || '';
      div.style.display = (!cid || cid === rowCid) ? '' : 'none';
    });
  }

  // ---------- 8) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ----------
  loadDashboard();
</script>

</body>
</html>
